#########################
## Included .cfg Files ##
#########################
[include mainsail.cfg]
[include v24/macros.cfg]
[include v24/stealthburner_leds.cfg]

#######################
## Canbus connection ##
#######################
[mcu]
canbus_uuid: e9f728d0e4b9
canbus_interface: can0

[mcu EBBCan]
canbus_uuid: 57cc2b4bd2da
canbus_interface: can0

########################
# Machine Specs/Limits #
########################
[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 11400                #Max --- set after input shapping
max_z_velocity: 15              #Max 15 for 12V TMC Drivers, can increase for 24V. I think I have 24v...
max_z_accel: 350
square_corner_velocity: 5.0

#########################
## Temperature Sensors ##
    #Pi CM4 rated at 0-80 degrees celcius
    #Setting both the MCU and CM4 between these temps to avoid issues
#########################
[temperature_sensor M8P]        #Manta M8P temp
sensor_type: temperature_mcu
min_temp: 10
max_temp: 70                    

[temperature_sensor CM4]	#Pi CM4 temp
sensor_type: temperature_host
min_temp: 10
max_temp: 70

[temperature_sensor EBBCan]     #Toolhead board temp
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 100

[temperature_sensor chamber]        #Chamber temp
sensor_type: Generic 3950
sensor_pin: PF4                     #Check pin on M8P
min_temp: 0
max_temp: 100
gcode_id: C

[temperature_sensor EBB_NTC]
sensor_type: Generic 3950
sensor_pin: EBBCan:gpio28

######################
# ADXL Accelorometer #        ##Copy updated
######################

#############
## Heatbed ##
    #Heater bed thermo sensor and heat control connected to M8P
    #Adjust max_power so it doesn't exceed the SSR rating.
    #The formula is "4/ (Wattage_of_bed_heater / Mains_voltage) = max_power"
    #If max_power is greater than 1.0, use 1.0
#############
[heater_bed]
#SSR Pin - HE1                   #Not needed. Uncomment the if using the default SSR wiring from the docs site
heater_pin: PA1                 
sensor_type: Generic 3950        #Use "Generic 3950" for NTC 100k 3950 thermistors
sensor_pin: PB1
max_power: 0.6                   #Using G3NB-210B-1. 4/(650/120)) = 0.73846. I left this at the default 0.6 
min_temp: 0
max_temp: 110                    #I set this at 10% above the max tempt I will ever use. 

##Not needed, will be auto-generated below
#control: pid              
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

##########################
## X/Y Stepper Settings ##
    #For quiet operation:
        #uncomment stealthchop_threshold: 999999
        #set interpolate: true
        #set microsteps: 16
    #For best positional accuracy:
        #comment out stealthchop_threshold: 999999
        #set interpolate: false
        #set microsteps: 64
    #Mix and match with interpolate:false and uncomment stealthchop
##########################
## X Stepper on MOTOR1 (B Motor) ##
[stepper_x]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
microsteps: 64        #Default 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: EBBCan:gpio24
position_min: 0

position_endstop: 300
position_max: 300

homing_speed: 50   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC13
interpolate: false        
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999        #Uncomment to switch to stealthChop (quiet mode)

## Y Stepper on MOTOR2 (A Motor) ##
[stepper_y]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
microsteps: 64        #Default 16
rotation_distance: 40
endstop_pin: ^PF3
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
position_min: 0

position_endstop: 300
position_max: 300

homing_speed: 50  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PE3
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

########################
## Z Steppers Settings ##
########################
## Z0 Stepper - Front Left on MOTOR3_A ##
[stepper_z]
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16        
endstop_pin:  probe:z_virtual_endstop        #Uses TAP

position_max: 290

position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PB9
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

## Z1 Stepper - Rear Left on MOTOR5 ##
[stepper_z1]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16      

[tmc2209 stepper_z1]
uart_pin: PG14
interpolate: true         
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

## Z2 Stepper - Rear Right on MOTOR6 ##
[stepper_z2]
step_pin: PG9
dir_pin: PD7
enable_pin: !PG11
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16        

[tmc2209 stepper_z2]
uart_pin: PG10
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

## Z3 Stepper - Front Right on MOTOR7 ##
[stepper_z3]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[tmc2209 stepper_z3]
uart_pin: PD5
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##############
## Extruder ##
##############
## E0 on MOTOR8, connected through EBBCan ##
[extruder]
step_pin: EBBCan:gpio18
dir_pin: !EBBCan:gpio19
enable_pin: !EBBCan:gpio17
microsteps: 16
rotation_distance: 33.500        #Recalculate new=oldx(actuall extruded/100)
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan:gpio7
sensor_type: MAX31865
sensor_pin: EBBCan:gpio9
spi_software_sclk_pin: EBBCan:gpio10
spi_software_mosi_pin: EBBCan:gpio8
spi_software_miso_pin: EBBCan:gpio11
rtd_nominal_r: 1000
rtd_reference_r: 4300
rtd_num_of_wires: 2
rtd_use_50Hz_filter: True
min_temp: 0
max_temp: 280        #Increase to 300? maybe

[tmc2209 extruder]
uart_pin: EBBCan:gpio20
interpolate: true
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

## Filament Sensor ##
#[filament_switch_sensor filament_sensor_entry]
#switch_pin: ^EBBCan:gpio22
#pause_on_runout: False
#insert_gcode:
#    M117 Filament Detected At Extruder!
#runout_gcode:
#    M117 No Filament Detected Before Extruder!
#    PAUSE

#[filament_switch_sensor filament_sensor_extruder]
#switch_pin: ^EBBCan:gpio6
#pause_on_runout: False
#insert_gcode:
#    M117 Filament Detected In Extruder!
#runout_gcode:
#    M117 No Filament In Extruder!

#####################
## Probe a.k.a TAP ##
#####################
[probe]
pin: ^EBBCan:gpio22
x_offset: 0
y_offset: 0
#z_offset: 0         #Auto added calculated at bottom
speed: 10.0
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.005
samples_tolerance_retries: 3

activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}

########################
## Stealthburner Fans ##
########################

#######################
## Case/Chamber Fans ##
#######################
[fan]
##  Print Cooling Fan - FAN0
pin: EBBCan:gpio13
kick_start_time: 0.5
##  Depending on your fan, you may need to increase this value
##  if your fan will not start. Can change cycle_time (increase)
##  if your fan is not able to slow down effectively
off_below: 0.10

[heater_fan hotend_fan]
##  Hotend Fan - FAN1
pin: EBBCan:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0

[fan_generic controller_fan]
##  Controller fan - FAN2
pin: PD12
kick_start_time: 0.5
max_power: 0.7
#heater: heater_bed

##############
## Lighting ##
##############
## Chamber Lighting
[output_pin caselight]
pin: PA3 	#Switch to  PD15 if using 5v LED 3 pin  
pwm:false
shutdown_value: 0
value:0

[delayed_gcode welcome]
initial_duration: 5.
gcode:
  SET_NOZZLE_LEDS_OFF
  START_TEMP_MONITOR
#######################
## Homing and Gantry ##
#######################
[idle_timeout]
timeout: 1800

[safe_z_home]
home_xy_position:150,150        #Centers toolhead before Z probing
speed:80
z_hop:10

[quad_gantry_level]
##	Use QUAD_GANTRY_LEVEL to level a gantry.
##	Min & Max gantry corners - measure from nozzle at MIN (0,0) and 
##	MAX (250, 250), (300,300), or (350,350) depending on your printer size
##	to respective belt positions

gantry_corners:
	-60,-10
	360,370

points:        #Probe points
	50,25
	50,225
	250,225
	250,25

speed: 100
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075        #Increase if errors
max_adjust: 10

##################################
## Manta M8P Pin Maping Aliases ##
##################################
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,		#Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,		#Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

## Copy Updated below
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.005
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 42.037
#*# pid_ki = 1.540
#*# pid_kd = 286.902
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.875
#*# pid_ki = 1.383
#*# pid_kd = 64.409
